---
output: github_document
---
<!-- Useful knitr chunk options -->
<!-- include = FALSE prevents code and results from showing (still runs code) -->
<!-- echo = FALSE prevents code from appearing, but not the results (e.g. figures) -->
<!-- message = FALSE prevents messages that are generated by code from appearing -->
<!-- fig.cap = "" adds caption to graphical results (e.g. ggplot) -->
<!-- eval = FALSE prevents code in chunk from running -->
<!-- ALL OPTIONS: https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf -->

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# supeRcrit

<!-- badges: start -->
<!-- badges: end -->

## Overview
The package title `supeRcrit` is an abbreviation of "supeRcritical" in reference to supercritical fluids. The package is designed as a tool for design, modeling, and optimization of supercritical CO~2~ and (to a lesser extent) subcritical water extraction processes. The package includes functions for:

1. Kinetic modeling of such processes using [Sovova's][ref1] Broken and Intact Cells (BIC) and the two-site [kinetic desorption][ref2] models (**this is a Work-In-Progress**). See help documentation for `?bicmod` and `?ktsmod`. Various supporting functions facilitate calculation of CO~2~, ethanol (EtOH), and water densities at sub- and supercritical conditions (see `?bendens`, `?etoh_dens`, and `?h2o_dens`).

2. Retrieval of various molecular descriptors and MOL files for target compounds from public online databases. See help documentation for `?mol_find`.

3. Predicting the effect of various co-solvents (as supercritical CO~2~ polarity modifiers) on the solubility of a target compound(s) using the [Hansen Solubility Parameters (HSP)][ref3]. See help documentation for `?sfe_mod`.

4. Estimating the boiling point, critical temperature, critical pressure, and Hansen Solubility Parameters using various methods including the [Joback][ref4], [Stein & Brown][ref5], [Nannoolal][ref6], [Stefanis & Panayiotou][ref7] and other approaches. See help documentation for `?est_gcm`.

5. Generating [Design of Experiments (DoE)][ref8] for both screening or process optimization. For an example, see help documentation for `?doe_ccd`.

6. Optimizing SFE and SWE processes using [Response Surface Methodology (RSM)][ref9] for one or multiple response variables. See help documentation for `?doe_analyze` and `?doe_desir`.

7. Calculating the [Cost of Manufacturing (COM)] for optimized SFE and SWE processes to maximize profit margin and finalize process extraction time. See help documentation for `?calcom`.

## Installation

Use the following command to install `supeRcrit` from [GitHub][github]:

``` {r, eval = FALSE}
install.packages(devtools)
devtools::install_github("Deniz-Koseoglu/supeRcrit", build_vignettes = TRUE)
```

The package may then be loaded via:

```{r}
library(supeRcrit)
```

The package documentation can be accessed with:

```{r, eval = FALSE} 
?supeRcrit # documentation
```

## Main functions
The main workflow of `supeRcrit` is supported by the following key and supporting functions (supporting functions tagged as **incorporated** are those which are mandatory for completion of the main workflow):

1. `bicmod` and `ktsmod` - kinetic modeling of SFE and SWE extraction processes using **Sovova's BIC model** and the **two-site kinetic desorption model**, respectively. Supporting functions:
    - `bendens` calculates supercritical CO~2~ density using the [Bender Equation of State][ref10]
    - `etoh_dens` calculates ethanol density at specific temperatures
    - `bic_sm`, `bic_ct`, and `bic_cmp` (**incorporated**) build a simplified, "characteristic times", and complete BIC models
    - `kin_plot` (**incorporated**) plots the model results
    - `kin_splot` visually summarizes the results of multiple kinetic models
    - `kin_export` summarizes and exports data in **.CSV** format
<br/><br/>
2. `sfe_mod` estimates the __*relative solubility improvement*__ of a target compound in supercritical CO~2~ when one or more co-solvents are used at a specific volume fraction(s) as polarity modifiers. Supporting functions:
    - `mol_find` retrieves molecular descriptors and a MOL file for a molecule given a [SMILES][link1] string, CAS number, and/or compound name (IUPAC or colloquial).
    - `est_gcm` estimates boiling point, critical parameters (temperature, volume, pressure), and/or HSPs via **Group Contribution Methods (GCMs)**.
    - `plot_gcm` (**incorporated**) visualizes a molecule from its MOL file and optionally highlights sub-structures
    - `hsp_optim` (**incorporated**) calculates the **relative solubility improvement (%)** of a target compound in supercritical CO~2~ using a specific volume fraction of various co-solvents. The "best" co-solvent resulting in the highest solubility improvement may be determined at one or more combinations of pressure and temperature within **75-1000 bar** and **31-200 degrees Celsius**, respectively.
    - `show_solv` displays reference HSP parameters and other data used by the workflow for various solvents.
<br/><br/>
3. `doe_analyze` systematically creates, analyzes, and (where appropriate) simplifies Design of Experiments models, including linear models using for screening experiments, as well as the more complex quadratic models used by **Response Surface Methodology (RSM)** for optimization of one or more responses. Supporting functions include:
    - `doe_ffd`, `doe_frfd`, `doe_ccd`, `doe_bbd`, and `doe_tm` generate **Designs of Experiments (DoE)** of various types including the Full Factorial, Fractional Factorial, Central Composite, Box-Behnken, and Taguchi designs for 2-5 factors.
    - `doe_export` and `doeopt_export` compile data from DoE generation and analysis, respectively, and export them as an informative **.TAB** file.
    - `doex` include some example data to work with.
    - Multiple other incorporated functions provide additional functionality but are not intended for standalone use.
<br/><br/>
4. `calcom` calculates the **Cost of Manufacturing (COM)** for SFE and SWE processes, including the labor, utilities, raw materials, waste management, and fixed costs. Payback period for a given investment at any point throughout the extraction process is also calculated, facilitating the choice of time that would maximize the profit margin. Supporting function include:
    - `show_pars` is a helper function explaining the **input and output terms** of the workflow
    - `com_export` compiles and exports all workflow output as a **.CSV** file.
    
For **detailed examples** of all workflows outlined herein, please consult package vignettes.

## Examples
### Co-Solvent Choice
This module uses the Hansen Solubility Parameters (HSPs) estimated by Group Contribution Methods (see above), and adjusted based on molar volume variation with temperature and pressure, to estimate an **HSP Distance** __**R~a~**__ between a target compound and a CO~2~-co-solvent mixture to be used for extraction. The workflow begins with retrieval of molecular descriptors from [SMILES][smiles], [CAS][cas], and/or common/[UIPAC][iupac] name of any chosen target compound. While this is carried out automatically as part of `sfe_mod`, it can also be done separately with `mol_find`: 

```{r hsp_1}
#Define beta-carotene as an example
mol <- c("CC1=C(C(CCC1)(C)C)C=CC(=CC=CC(=CC=CC=C(C)C=CC=C(C)C=CC2=C(CCCC2(C)C)C)C)C",
"7235-40-7", "Beta-carotene")

#Retrieve and view molecular descriptors
mol_desc <- mol_find(mol)
mol_desc$IDs[!names(mol_desc$IDs) %in% "InChI"]
```

The function `sfe_mod` may then be used to estimate critical temperature, boiling point, HSP parameters, and calculate distance __**R~a~**__ with the associated **Miscibility Enhancement (%)** provided by various co-solvent versus pure CO~2~. In the following example, we compare the co-solvent performance of hexane, methanol, and methyl oleate at a volume fraction of 10% that of CO~2~:

```{r hsp_2, message = FALSE, fig.retina = 3}
#Compare co-solvent performance of 10% hexane, ethanol, and methyl oleate for dissolving beta-carotene
optres <- sfe_mod(solute = mol,
                  modif = c("Hexane", "Ethanol", "MethylOleate"),
                  vfrac = 0.1,
                  tb = "SB_corr",
                  crit = "NL07_robust",
                  hsp = "SP12")

#View miscibility enhancement for hexane (for example) at various temperatures and pressures
optres$sfe$Miscib_Enhancement$`CO2 with Hexane`

#View best co-solvent at various temperatures and pressures
optres$sfe$Best_Modifier

#View co-solvent ranking based on the number of temperature-pressure couplings where it results in the highest miscibility
optres$sfe$Modifier_Ranking

#View estimated critical parameters
optres$parameters$Critical

#View estimated HSPs
optres$parameters$HSP

#View detected functional groups and their contribution to the GCM estimation methods
optres$parameters$Contribs

#Plot detected functional groups for HSP GCM (as an example)
grid::grid.raster(optres$gcm_vis$HSP)

```

The workflow can also predict miscibility enhancement for solvent **mixtures** with two or more components using the `modif` argument:
```{r hsp_3, message = FALSE}
optres_2 <- sfe_mod(solute = mol,
                    modif = list(c("Ethanol", "Water"), "Ethanol", "MethylOleate"),
                    modfracs = list(50),
                    tb = "SB_corr",
                    crit = "NL07_robust",
                    hsp = "SP12")

#View the miscibility enhancement of 50:50 Ethanol:Water
optres_2$sfe$Miscib_Enhancement$`CO2 with Ethanol:Water (50:50)`

#View final co-solvent ranking
optres_2$sfe$Modifier_Ranking
```

### Kinetic modeling (Work-In-Progress)
Modeling of the extraction curve allows the derivation of various parameters about the **Overall Extraction Curve (OEC)** of a given SFE or SWE process. For more detail and examples, consult the __**Kinetic Modeling**__ vignette. Various types of BIC (Sovova) and KTS (two-site desorption) models may be generated via their respective functions, `bicmod` and `ktsmod`. As input data, a table of time and a response(s) is used to model the extraction curve.

```{r kinmod_1}
## Load and view example data for kinetic modeling
kin_smp <- swex[["duba1"]][["data"]]
kin_smp
```

This data includes SWE results obtained via SWE of defatted grape seeds at 80-120 degrees Celsius (100 degrees are used here) and 15 bar and 2 mL/min of water flow. The extractable material fraction `c0` is set to 77 permille (parts per thousand), and the mass of sample is 2 grams. The fraction of easily-desorbed solute, `f`, is set to 0.24 - while this parameter is usually estimated by the model, it may be provided separately where an accurate value was previously determined. Non-linear optimization `nlopt` is used for convergence, and no initial estimates of output parameters is given in `opt_est`. 

```{r kinmod_2, message = FALSE, fig.retina = 3}
twosite_res <- ktsmod(oec = swex[["duba1"]][["data"]],
oec_vars = c(x = "Time_min", y = "Yield_100C"),
pars = c(pres = 15, temp = 100, flow = 2, c0 = 77, m_in = 2, f = 0.24),
opt_est = "default",
units = c(flow = "mL/min", resp = "permille"),
plot_units = c(x = "q", y = "abs"),
cumulative = TRUE,
mass_flow = FALSE,
flowpar = rep(NA,2),
ro_h2o = NA,
tmax = NA,
qmax = NA,
optmet = "nlopt",
draw = FALSE)

#Draw model plot
twosite_res$plots$tws
```


It is also possible to view model data and various input, fit, and overall model parameters:
```{r kinmod_3, message = FALSE}
#View input data with appended model predictions
twosite_res$data

#View model parameters
twosite_res$tws$mod_pars

#Check which of these parameters were modelled
twosite_res$tws$fit_pars

#Check input parameters
twosite_res$input
```

### Design of Experiments (DoE) generator
This workflow is able to generate Full Factorial, Fractional Factorial, Central Composite, Box-Behnken, and Taguchi experimental design matrices with 2-5 factors and 2-5 levels. Additional options include flexible aliasing patterns, run order randomization, exporting of results, addition of center points, factor names etc. Some examples of design generation are presented below:

```{r doe_1, echo = FALSE}
#Full Factorial Design with 3 levels, 3 factors, and 3 ADDITIONAL center points
doe_ffd(levels = 3,
        factors = 3,
        cpts = 3,
        fnames = c("Pressure", "Temperature", "Flow"),
        flims = list(c(100, 500), c(35, 70), c(2, 4)))

#Fractional Factorial Design (2^5-2), with 5 factors and 2 levels (suitable for screening experiments)
doe_ffd(levels = 3,
        factors = 3,
        cpts = 3,
        fnames = c("Pressure", "Temperature", "Flow"),
        flims = list(c(100, 500), c(35, 70), c(2, 4)))

#Central Composite Circumscribed for 4 factors (standard CCD)
doe_ccd(design = "CCC",
        levels = 5,
        factors = 3,
        cpts = 6,
        fnames = c("Pressure", "Temperature", "Co-Solvent"),
        flims = list("hard"=c(100, 345), "hard"=c(35, 75), c(2, 8)))
```

### Response Surface Methodology for DoE Analysis
Once experimental runs associated with any given DoE are completed, a model of the process may be constructed via Response Surface Methodology (RSM). This functionality is provided by the `doe_analyze` workflow, which build and "trims" a linear or quadratic model based on the results of Lack-of-Fit (LoF) testing, ANOVA, Stepwise Regression, p-value cutoff, and other metrics. Both the final and initial models are then summarized and visualized, and optimum process parameters determined by Canonical Analysis and/or non-linear optimization. An example of a [Central Composite Design (CCD)][ccd] carried out for the SFE of [spearmint flavonoids][ref11] is shown below:

```{r doe_4, message = FALSE, fig.retina = 3}
doe_optres <- doe_analyze(doe = doex[["ccd3"]][["data"]],
                          uc_facs = c("P_bar", "T_degC", "EtOH_gmin"),
                          cent_id = NA,
                          resp_var = "ExtYield",
                          time_var = "Actual_Order",
                          mod_order = 2,
                          canon_thres = "auto",
                          p_cutoff = 0.10,
                          trim_method = "both",
                          which_facs = "coded",
                          export = "none",
                          verbose = FALSE)

#View final model results (coefficients, t-values, p-values, ANOVA metrics)
doe_optres$results$final$Model_Results

#View final model plot of predicted versus actual response
doe_optres$plots$final$FinalModel_ExtYield_vs_Predicted

#View optimized factor values for maximum response (coded)
doe_optres$results$final$Model_Metrics$Canonical_Analysis$xs

#View optimized factor values for maximum response (decoded)
doe_optres$results$final$Model_Metrics$Canonical_Analysis$xs_decoded

#View the results of non-linear optimization (alternative to canonical analysis)
doe_optres$results$final$Model_Metrics$Trad_Opt
```

## Further Details
The **.PDF vignettes** included with the package are: 

1. *Kinetic Modeling of SFE and SWE* - all aspects of SFE and SWE kinetic modeling available in `supeRcrit`.
2. *Selecting co-solvents for SFE using Hansen Solubility* - estimation of co-solvent miscibility improvement with addition of various co-solvents and their mixtures.
3. *Design of Experiments (DOE) generation* - design of experiments generation and their analysis via RSM.
4. *Cost of Manufacturing calculation* - all parameters and examples of COM calculations for SFE and SWE processes.

These provide detailed information for all co-solvent selection, process parameter optimization, cost of manufacturing calculation, and other workflows. Reading them and applying the examples therein is highly recommended.

[github]: https://www.github.com/Deniz-Koseoglu/supeRcrit
[smiles]: https://www.daylight.com/dayhtml/doc/theory/theory.smiles.html
[cas]: https://www.cas.org/about/cas-history
[iupac]: https://iupac.qmul.ac.uk/class/intro.html
[ccd]: https://www.itl.nist.gov/div898/handbook/pri/section3/pri3361.htm
[ref1]: https://www.doi.org/10.1016/j.supflu.2017.02.014
[ref2]: https://www.doi.org/10.1016/S0021-9673(02)01329-8
[ref3]: https://www.doi.org/10.1016/j.jfoodeng.2025.112538
[ref4]: https://www.doi.org/10.1080/00986448708960487
[ref5]: https://www.doi.org/10.1021/ci00019a016
[ref6]: https://www.doi.org/10.1016/j.fluid.2006.11.014
[ref7]: https://www.doi.org/10.1016/j.ijpharm.2012.01.001
[ref8]: https://www.doi.org/10.18434/M32189
[ref9]: https://www.doi.org/10.1007/s11947-016-1855-2
[ref10]: https://www.doi.org/10.3303/CET1974120
[ref11]: https://www.doi.org/10.1007/s11947-010-0504-4
